const e=require("fire-path"),t=require("fire-url"),i=require("fire-fs"),{format:r,promisify:s}=require("util"),n=require("electron").ipcMain,o=require("globby"),a=require("gulp").Gulp,l=require("gulp-rename"),u=require("gulp-util"),c=require("event-stream"),d=require("stream-combiner2"),p=require("gulp-rev-all"),f=require("gulp-rev-delete-original"),m=require("del"),b=require("async"),g=require("lodash"),

//Add os
os=require("os"),

h=require("winston"),j=require("crypto"),v=require("./compiler"),y=require("./native-utils"),w=require("../share/build-platforms"),E=require("./build-results"),k=Editor.require("app://editor/share/3d-physics-build-utils"),S=Editor.require("app://editor/share/bundle-utils"),x="build-platform_",C="db://",M="window._CCSettings",A=5,B=["SubContext","Canvas Renderer"],T="default",_="merge_all_json",q="subpackage",D="zip";let F=null,U=!1;function O(e,t,...i){return new Promise(r=>{e.send(t,...i,(...e)=>{r(...e)},-1)})}function $(t){return c.through(function(i){if(".html"===e.extname(i.path)){h.normal("Generating html from "+i.path);var r=t.webOrientation;"auto"===r&&(r="");const n=Editor.url("app://node_modules/vConsole/dist/vconsole.min.js"),o=`<script src="${e.basename(n)}"><\/script>`;var s={file:i,project:t.projectName||e.basename(t.project),previewWidth:t.previewWidth,previewHeight:t.previewHeight,orientation:r,webDebugger:t.embedWebDebugger?o:""};i.contents=new Buffer(u.template(i.contents,s))}else if("main.js"===e.basename(i.path)){h.normal("Generating main.js from "+i.path);let e=i.contents.toString();s={file:i,renderMode:t.renderMode,engineCode:"",projectCode:""};i.contents=new Buffer(u.template(e,s))}this.emit("data",i)})}function P(e,t){var i=JSON.stringify(e,null,t?4:0).replace(/"([A-Za-z_$][0-9A-Za-z_$]*)":/gm,"$1:");return i=t?`${M} = ${i};\n`:`${M}=${i};`}async function W(e,t,...i){let r=I(t.actualPlatform,e);if(r)try{return await r(t,...i)}catch(e){Editor.error(e)}}function I(e,t){let i=Editor.Builder.simpleBuildTargets[e];return i&&i[t]||null}function R(e,i){var r=e.root,s=e.buildResults,n={},o=e.sceneList,a=e.debug,l=!e.preview,u=Editor.assetdb,c=Editor.assets,d=Editor.Utils.UuidUtils.compressUuid;function p(e,i){if(!e)return console.error("can not get url to build: "+i),null;if(!e.startsWith(C))return console.error("unknown url to build: "+e),null;var r=u.isSubAssetByUuid(i),s=e;r&&(s=t.dirname(e));var n=t.extname(s);return n&&(s=s.slice(0,-n.length)),{uuid:i,relative:s,isSubAsset:r}}(function(e,t){if(e){for(var i=e.getAssetUuids(),s=[],n=0,o=i.length;n<o;n++){var a=i[n],l=u.uuidToUrl(a),d=u.assetInfoByUuid(a);if(d){var f=d.type;if(f){var m=p(l,a);if(!m)continue;var b=c[f];m.ctor=b||cc.Asset,m.url=l,m.redirect=e._buildAssets[a].redirect,s.push(m)}else console.error("Can not get asset type of "+a)}else s.push({uuid:a,url:"",relative:"",ctor:cc.Asset})}t(null,s)}else{if(!r)return t(null,[]);console.time("queryMetas"),u.queryMetas(r+"/**/*","",function(e,i){console.timeEnd("queryMetas");for(var r=[],s=0,n=i.length;s<n;s++){var o=i[s],a=o.assetType();if("folder"!==a&&"javascript"!==a&&"typescript"!==a){var l=o.uuid,d=u.uuidToUrl(l),f=p(d,l);if(f){var m=c[a];f.ctor=m||cc.Asset,f.url=d,r.push(f)}}}t(e,r)})}})(s,function(t,u){if(t)return i(t);var c=[],p=[],f=[];u.forEach(e=>{var t=e.uuid;if(e.ctor===cc.SceneAsset&&-1===o.indexOf(t)&&o.push(t),l&&(t=d(t,!0)),c.push(t),e.redirect){p.push(t);var i=f.indexOf(e.redirect);-1===i&&(i=f.length,f.push(e.redirect)),p.push(i)}}),function(e){var t,i=n.paths={};a||(t=n.types=[]);var s={};e=g.sortBy(e,"relative");for(var o=Object.create(null),u=0,c=e.length;u<c;u++){var p=e[u];if(!p.ctor){Editor.error(`Failed to get ctor of '${p.relative}'(${p.uuid}).\n`+"Please ensure the asset class is loaded in the main process of the editor.");continue}if(p.ctor===cc.SceneAsset)continue;if(!p.url.startsWith(r+"/"))continue;if(p.isSubAsset&&cc.js.isChildClassOf(p.ctor,cc.SpriteFrame)){var f,m=p.relative;if(m in o)f=o[m];else{let t=m+".";f=e.some(function(e){var i=e.relative;return(i===m||i.startsWith(t))&&!e.isSubAsset&&e.ctor===cc.SpriteAtlas}),o[m]=f}if(f)continue}var b=cc.js._getClassId(p.ctor,!1);if(!a){var h=s[b];void 0===h&&(t.push(b),h=t.length-1,s[b]=h),b=h}var j=[p.relative.slice(r.length+1),b];p.isSubAsset&&j.push(1);let n=p.uuid;l&&(n=d(n,!0)),i[n]=j}}(u),n.uuids=c,function(e){n.scenes={},e.forEach(e=>{var t=Editor.assetdb.uuidToUrl(e);t?(l&&(e=d(e,!0)),-1===n.uuids.indexOf(e)&&n.uuids.push(e),n.scenes[t]=e):Editor.warn(`Can not get url of scene ${e}, it maybe deleted.`)})}(o),n.redirect=p,n.deps=f,n.packs=s?function(e){if(l&&e){var t={};for(var i in e){var r=e[i];t[i]=r.map(e=>d(e,!0))}e=t}return e}(s._packedAssets):{},n.name=e.name,n.importBase=e.importBase,n.nativeBase=e.nativeBase,n.debug=a,n.isZip=e.isZip,n.encrypted=e.encrypted,(!("stringify"in e)||e.stringify)&&(n=JSON.stringify(n,null,a?4:0)),i(null,n)})}function L(e,t){var i=e.customSettings,r=e.debug,s=Object.create(null);let n=function(e){return I(e,"extends")||e}(i.platform),o=w[n].isNative;var a=Editor.assetdb;e.launchScene&&(i.launchScene=Editor.assetdb.uuidToUrl(e.launchScene)),i.orientation=e.orientation,i.server=e.server,r&&(i.debug=!0),a.queryMetas("db://**/*","javascript",function(n,l){var u;u=o?e=>e.isPlugin&&e.loadPluginInNative:e=>e.isPlugin&&e.loadPluginInWeb;var c=l.filter(u).map(e=>e.uuid);(function(e,t){for(var i=[],r=0;r<t.length;r++){var n=t[r],o=a.uuidToUrl(n);o=o.slice(C.length),s[o]=n,i.push(o)}i.sort(),e.jsList=i})(i,c),(!("stringify"in e)||e.stringify)&&(i=P(i,r)),t(null,i,s)})}exports.startWithArgs=async function(t,g){let M,z;B.forEach(e=>{t.excludedModules.includes(e)||t.excludedModules.push(e)});try{M=k.getPhysicsModule(t.excludedModules),z=M&&k.getPhysicsBuildFlags(M)}catch(e){return g(e)}await async function(e){return await W("buildStart",e)}(t);var N=new a;function J(e){let t=!0;return function(...i){let r=i[0];t?(t=!1,e&&e(...i)):r&&Editor.error(r)}}var H=t.project,Z=t.platform,G=t.actualPlatform;let V="runtime"===Z,Q="mini-game"===Z;var Y=!!t.debug,K=t.sourceMaps,X=t.webOrientation;"auto"===X&&(X=""),U!==t.debugBuildWorker&&je(),U=t.debugBuildWorker;var ee=w[Z],te=ee.isNative,ie=t.dest;if(i.existsSync(ie)||(t.buildScriptsOnly=!1),Editor.log("Building "+H),Editor.log("Destination "+ie),e.normalize(ie)===e.normalize(H))return g(new Error("Can not export project at project folder."));if(e.contains(Editor.App.path,ie))return g(new Error("Can not export project to fireball app folder."));var re,se={tmplBase:e.resolve(Editor.url("unpack://static"),"build-templates"),

    //jsCacheDir:Editor.url("unpack://engine/bin/.cache/"+G),
    jsCacheDir:Editor.url(os.homedir()+"/.cache/"+G),
    
    backupDir:"js backups (useful for debugging)"};re=Y?te?V?"cocos2d-runtime.js":"cocos2d-jsb.js":"cocos2d-js.js":te?V?"cocos2d-runtime-min.js":"cocos2d-jsb-min.js":"cocos2d-js-min.js",Object.assign(se,{template_shares:e.join(se.tmplBase,"shares/**/*"),template_web_desktop:e.join(se.tmplBase,Y?"web-desktop/template-dev/**/*":"web-desktop/template/**/*"),template_web_mobile:e.join(se.tmplBase,Y?"web-mobile/template-dev/**/*":"web-mobile/template/**/*"),src:e.join(ie,"src"),assets:e.join(ie,"assets"),remote:e.join(ie,"remote"),subpackages:e.join(ie,"subpackages"),settings:e.join(ie,"src/settings.js"),jsCache:e.join(se.jsCacheDir,re),jsCacheExcludes:e.join(se.jsCacheDir,Y?".excludes":".excludes-min"),webDebuggerSrc:Editor.url("app://node_modules/vconsole/dist/vconsole.min.js"),template_instant_games:e.join(se.tmplBase,"fb-instant-games/**/*"),quickScripts:e.join(H,"temp/quick-scripts"),destQuickScripts:e.join(ie,"scripts")});let ne=t.bundles=[];N.task("query-bundles",async function(){let i=require(Editor.url("app://editor/share/build-utils")),{MAIN:r,START_SCENE:s}=cc.AssetManager.BuiltinBundleName,n=await S.queryBundlesWithScenes(),o=await S.queryBundleFolders();S.verifyBundleFolders(o);for(let e in n)n[e]=n[e].map(e=>e.uuid);o.forEach(t=>{let{url:i,name:r,compressionType:s,priority:o,optimizeHotUpdate:a,inlineSpriteFrames:l,isRemoteBundle:u}=t,c=s[G]===q,d=!c&&u[G],p=e.join(c?se.subpackages:d?se.remote:se.assets,r);ne.push({root:i,name:r,dest:p,scriptDest:c||ee.supportDownloadScript||!d?p:e.join(se.src,"scripts",r),priority:o,scenes:n[r]||[],compressionType:s[G]||("db://internal/resources"===i?_:T),optimizeHotUpdate:a[G],inlineSpriteFrames:l[G],isRemote:d})});let a=n[r];!(!Q&&!V)&&t.startSceneAssetBundle&&(ne.push({root:null,priority:9,dest:e.join(se.assets,s),scriptDest:e.join(se.assets,s),name:s,scenes:[t.startScene],compressionType:_,optimizeHotUpdate:!1,inlineSpriteFrames:!1,isRemote:!1}),a=a.filter(e=>e!==t.startScene)),a=a.filter(e=>!t.excludeScenes.includes(e));let l=i.supportSubpackage(G)&&t.mainCompressionType===q,u=!l&&ee.supportRemoteMain&&i.supportRemote(G)&&t.mainIsRemote,c=e.join(l?se.subpackages:u?se.remote:se.assets,r),d=t.mainCompressionType||T;d===D&&!i.supportZip(G)&&(d=T),ne.push({root:null,priority:7,dest:c,scriptDest:l||ee.supportDownloadScript||!u?c:e.join(se.src,"scripts",r),name:r,scenes:a,compressionType:d,optimizeHotUpdate:t.optimizeHotUpdate,inlineSpriteFrames:t.inlineSpriteFrames,isRemote:u})}),N.task("compile",function(e){Editor.Ipc.sendToMain("builder:state-changed","compile",.25);var t={project:H,platform:Z,actualPlatform:G,debug:Y,sourceMaps:K,bundles:ne,compileFlags:z};v._runTask(t,function(t){t?e(t):e()})}),N.task("build-assets",function(e){Editor.Ipc.sendToMain("builder:state-changed","build-assets",.8);let i=J(e);if(t.buildScriptsOnly)return i();function r(){h.normal("Start build-assets in worker");let e=.5;Editor.Ipc.sendToMain("builder:state-changed","start build-assets",e);var r=new Array(11);ne.forEach(e=>{r[e.priority-1]||(r[e.priority-1]=[]),r[e.priority-1].push(e)});let s=(.7-.5)/(r=r.filter(e=>e).reverse()).length;var n=Object.create(null);b.eachSeries(r,(r,o)=>{b.eachSeries(r,(r,o)=>{var a={inlineSpriteFrames:r.inlineSpriteFrames,optimizeHotUpdate:r.optimizeHotUpdate};a.scenes=r.scenes,a.compressionType=r.compressionType,a.sharedUuid=n;let l=I(t.actualPlatform,"buildConfig");l&&(l.hasOwnProperty("pack"),1)&&(a.pack=l.pack),e+=s,Editor.Ipc.sendToMain("builder:state-changed",`building [${r.name}] assets`,e),h.normal(`\n--- build-asset: ${JSON.stringify(r)}\n`),F.window.send("app:build-assets",r,G,Y,a,function(e,t,s,n){if(!he){if(e)i(e),he=!0;else if(t){var a=new E(t,s);r.buildResults=a,r.pacInfos=n}o(e)}},-1)},e=>{if(!e){const e=Object.create(null);r.forEach(t=>{var i=t.pacInfos;i&&i.forEach(i=>{const r=i.relativePath;e[r]?Editor.warn(`The AutoAtlas ${r} exists                                             in two bundles with the same priority: ${t.name}, ${e[r].name}.                                             This may result in inconsistent atlas data in each bundle.                                             You can change the priority of one of those bundles to resolve it`):e[r]=t}),t.buildResults.getAssetUuids().forEach(e=>{n[e]||(n[e]=t.name)})})}o(e)})},e=>{e||h.normal("Finish build-assets in worker"),i(e)})}if(ge=i,he=!1,Editor.Ipc.sendToMain("builder:state-changed","init build-assets-worker",.32),F.initBuildWorkerForAssets)return r(),void 0;h.normal("Start init build-worker"),F.window.send("app:init-build-worker",G,Y,function(e){e?(i(e),he=!0):he||(h.normal("Finish init build-worker"),F.initBuildWorkerForAssets=!0,r())},-1)}),N.task("build-configs",function(e){if(t.buildScriptsOnly)return e();b.eachSeries(ne,(e,i)=>{R({stringify:!1,name:e.name,importBase:"import",nativeBase:"native",root:e.root,buildResults:e.buildResults,sceneList:e.scenes,debug:Y,preview:!1,isZip:"zip"===e.compressionType,encrypted:te&&!V&&t.encryptJs&&!Y},(t,r)=>{e.config=r,i(t)})},t=>{t?error(t):e()})});var oe=null,ae=null;function le(e,i){var r=[se.template_shares,e];return N.src(r).pipe($(t)).pipe(N.dest(ie)).on("end",i)}N.task("build-settings",function(e){let{RESOURCES:i,START_SCENE:r}=cc.AssetManager.BuiltinBundleName;var s=Editor.Profile.load("project://project.json"),n={platform:G,groupList:s.get("group-list"),collisionMatrix:s.get("collision-matrix"),hasResourcesBundle:!!ne.find(e=>e.name===i),hasStartSceneBundle:!!ne.find(e=>e.name===r),remoteBundles:ne.filter(e=>e.isRemote).map(e=>e.name),subpackages:ne.filter(e=>e.compressionType===q).map(e=>e.name)};let o={debug:Y,stringify:!1,customSettings:n,launchScene:t.scenes[0],orientation:te?"":X};te&&!V&&(o.server=t[G].REMOTE_SERVER_ROOT),L(o,function(i,r,s){i?e(i):(t.settings=oe=r,ae=s,e())})}),N.task("compress-configs",function(e){if(Y||t.buildScriptsOnly)return e();function i(e){let t={},i={};function r(e){var r=(t[e]||0)+1;t[e]=r,e in i||(i[e]=e)}let s=e.paths;for(let e in s)r(e);let n=e.scenes;for(let e in n)r(n[e]);let o=e.packs;for(let e in o)o[e].forEach(r);let a=e.versions;for(let e in a){let t=a[e];for(let e=0;e<t.length;e+=2)r(t[e])}let l=e.redirect;for(let e=0;e<l.length;e+=2)r(l[e]);return e.uuids.sort((e,i)=>t[i]-t[e]),e.uuids.forEach((e,t)=>i[e]=t),i}for(var r=0;r<ne.length;r++){var s=ne[r].config,n=i(s);let e=s.paths,a=s.paths={};for(let t in e){var o=e[t];a[n[t]]=o}let l=s.scenes;for(let e in l){let t=n[l[e]];l[e]=t}let u=s.packs;for(let e in u){let t=u[e];for(let e=0;e<t.length;++e){let i=n[t[e]];t[e]=i}}if(t.md5Cache){let e=s.versions;for(let t in e){let i=e[t];for(let e=0;e<i.length;e+=2){let t=n[i[e]];i[e]=t}}}let c=s.redirect;for(let e=0;e<c.length;e+=2){let t=n[c[e]];c[e]=t}}e()}),N.task("build-web-desktop-template",function(e){le(se.template_web_desktop,e)}),N.task("build-web-mobile-template",function(e){le(se.template_web_mobile,e)}),N.task("build-fb-instant-games-template",function(e){le(se.template_instant_games,e)}),N.task("build-plugin-scripts",function(i){let r=J(i);Editor.log("Start building plugin scripts");var s=Editor.assetdb,n=[];let o=function(i){for(var r in ae){var o=ae[r];let c=s.uuidToFspath(o);var a=e.dirname(e.join(se.src,r));console.log(`start gulpping ${c} to ${a}`);var l=N.src(c);if(!Y){var u=Editor.require("unpack://engine/gulp/util/utils").uglify;let e={jsb:te&&!V,runtime:V,debug:Y,support_jit:!1},r=I(t,G);r&&Object.assign(e,r),l=l.pipe(u("build",e)),d.obj([l]).on("error",function(e){i(e.message)})}l=l.pipe(N.dest(a)).on("end",()=>{console.log("finish gulpping",c)}),n.push(l)}n.length>0?c.merge(n).on("end",()=>{Editor.log("Finish building plugin scripts"),i()}):i()};ae?o(r):function(e,t){Editor.Ipc.sendToMain("app:query-plugin-scripts",e,(e,i)=>{if(e)return t&&t(e,null),void 0;let r={};i.forEach(e=>{let t=Editor.assetdb.fspathToUuid(e),i=Editor.assetdb.uuidToUrl(t);i=i.slice(C.length),r[i]=t}),t&&t(null,r)})}(Z,(e,t)=>{if(e)return r(e);ae=t,o(r)})}),N.task("copy-main-js",function(){return N.src([e.join(se.tmplBase,"shares/main.js")]).pipe($(t)).pipe(N.dest(ie))}),N.task("copy-build-template",function(r){Editor.Ipc.sendToMain("builder:state-changed","copy-build-templates",.98);let s=e.basename(t.dest),n=e.join(t.project,"build-templates");if(!i.existsSync(n))return r();let a=e.join(n,s),l=[e.join(a,"**/*")];["game.json","project.config.json","project.swan.json","manifest.json"].forEach(t=>{l.push(`!${e.join(a,t)}`)}),o(l,(s,o)=>{(o=o.map(t=>e.resolve(t))).forEach(r=>{let s=e.relative(n,r),o=e.join(t.buildPath,s);i.ensureDirSync(e.dirname(o)),i.copySync(r,o)}),r&&r(s)})});var ue=require(Editor.url("unpack://engine/gulp/tasks/engine")),ce=async function(e,i){var r=te?V?"buildRuntime":"buildJsb":"buildCocosJs";r+=Y?"":"Min";let s=ue.excludeAllDepends(t.excludedModules);console.log("Exclude modules: "+s);let n={runtime:V,support_jit:!1},o=await async function(e){let t=await W("compileFlags",e);return"object"==typeof t?t:null}(t);o&&Object.assign(n,o),Object.assign(n,z),t.separateEngineMode&&(n.physics_builtin=!1,n.physics_cannon=!0),Editor.Ipc.sendToAll("builder:state-changed","start engine",.2),await O(F.window,"app:build-cocos2d",{func:r,sourceFile:Editor.url("unpack://engine/index.js"),outputFile:e,excludes:s,opt_macroFlags:n,sourceMaps:t.sourceMaps}),i&&i()};function de(e){let t=j.createHash("md5");for(let r=0;r<e.length;r++){let s;try{s=i.readFileSync(e[r])}catch(e){Editor.error(e);continue}t.update(s)}let r=t.digest("hex");return r=r.slice(0,A)}function pe(t){let r=de(t),s=t,n=[],o=t[0],a=Editor.Utils.UuidUtils.getUuidFromLibPath(o),l=e.dirname(o);return e.basenameNoExt(l)===a&&(s=[l]),s.forEach(e=>{let t=e.replace(Editor.Utils.UuidUtils.Reg_UuidInLibPath,e=>e+"."+r);try{i.renameSync(e,t)}catch(e){u.log(`[31m[MD5 ASSETS] write file error: ${e.message}[0m`)}n.push(t)}),{hash:r,renamedPaths:n}}async function fe(t){const i=Editor.Utils.UuidUtils.getUuidFromLibPath;var r=await s(o)(t,{nodir:!0});let n={};for(let t=0;t<r.length;t++){let s=r[t],o=i(e.relative(ie,s));o?(n[o]||(n[o]=[]),n[o].push(s)):Editor.warn(`Can not resolve uuid for path "${s}", skip the MD5 process on it.`)}for(let e in n){let t=n[e];t=t.sort(),n[e]=pe(t).hash}return n}function me(t,r){let s=[t],n=ee.supportDownloadScript;n&&s.push(r);let o=de(s);try{let s=e.join(e.dirname(t),`config.${o}.json`);if(i.renameSync(t,s),n){let t=e.join(e.dirname(r),`index.${o}.js`);i.renameSync(r,t)}}catch(e){u.log(`[31m[MD5 ASSETS] write file error: ${e.message}[0m`)}return o}function be(t){if(ee.supportDownloadScript&&t.jsList&&t.jsList.length>0){var r=se.src,s=t.jsList.map(t=>e.resolve(r,t)).map(t=>{return t=function(t){let r=de([t]),s=e.join(e.dirname(t),e.basenameNoExt(t)+"."+r+e.extname(t));try{i.renameSync(t,s)}catch(e){u.log(`[31m[MD5 ASSETS] write file error: ${e.message}[0m`)}return s}(t),e.relative(r,t).replace(/\\/g,"/")});s.sort(),t.jsList=s}}N.task("build-cocos2d",async function(r){Editor.Ipc.sendToAll("builder:state-changed","building physics",.1),ge=J(r),await O(F.window,"app:build-physics",t);let n=ie;te&&(n=e.join(ie,"src"));let o=await async function(e){return await W("engineBuildPath",e)}(t);if(o&&(n=o),i.ensureDirSync(se.jsCacheDir),t.separateEngineMode&&"qgame"===G)t.excludedModules=[...B].sort();else{t.excludedModules=t.excludedModules?t.excludedModules.sort():[];let e=await s(Editor.assetdb.queryAssets.bind(Editor.assetdb))(null,"typescript");const i="TypeScript Polyfill";let r=t.excludedModules.indexOf(i);-1===r&&0===e.length?t.excludedModules.push(i):r>-1&&e.length>0&&t.excludedModules.splice(r,1)}let a=!1;if(i.existsSync(se.jsCacheExcludes)){let e=i.readJSONSync(se.jsCacheExcludes);e.excludes&&e.version&&(a=Editor.versions.cocos2d===e.version&&e.excludes.toString()===t.excludedModules.toString()&&e.sourceMaps===t.sourceMaps&&e.separateEngineMode===t.separateEngineMode)}function u(e){let t=[se.jsCache];K&&t.push(se.jsCache+".map");let i=N.src(t,{allowEmpty:!0});te&&(i=i.pipe(l(V?"cocos2d-runtime.js":"cocos2d-jsb.js"))),(i=i.pipe(N.dest(n))).on("end",e)}if(a&&i.existsSync(se.jsCache))return await s(u)(),r(),void 0;await s(ce)(se.jsCache),await s(u)(),i.writeFileSync(se.jsCacheExcludes,JSON.stringify({excludes:t.excludedModules,version:Editor.versions.cocos2d,sourceMaps:t.sourceMaps,separateEngineMode:t.separateEngineMode}),null,4),r()}),N.task("copy-webDebugger",function(){var r=e.join(ie,e.basename(se.webDebuggerSrc));return t.embedWebDebugger?s(i.copy)(se.webDebuggerSrc,r):m(r.replace(/\\/g,"/"),{force:!0})}),N.task("revision-asset-jsList",async function(){let r=t.md5Cache;if(t.buildScriptsOnly)return oe.jsList=Object.keys(ae),r&&be(oe),void 0;const s=Editor.Utils.UuidUtils.compressUuid;if(r){console.time("revision");for(let t=0;t<ne.length;t++){let r=ne[t];if("zip"===r.compressionType){let t=r.dest,s=e.join(t,"res.zip"),n=[];[e.join(t,"native"),e.join(t,"import")].filter(e=>i.existsSync(e)).forEach(t=>{let r=o.sync(e.join(t,"**/*"),{absolute:!0});r=r.filter(e=>{return i.statSync(e).isFile()}),n=n.concat(r)});let a=de(n);i.renameSync(s,e.join(e.dirname(s),`${e.basenameNoExt(s)}.${a}.zip`)),r.config.zipVersion=a;continue}let n=[],a=await fe(e.join(r.dest,"import","**"));for(let e in a)n.push(s(e,!0),a[e]);let l=[],u=await fe(e.join(r.dest,"native","**"));for(let e in u)l.push(s(e,!0),u[e]);r.config.versions={import:n,native:l},r.buildResults._md5Map=a,r.buildResults._nativeMd5Map=u}be(oe),console.timeEnd("revision")}for(let t=0;t<ne.length;t++){let r=ne[t];if("zip"!==r.compressionType)continue;let s=r.dest,n=[];[e.join(s,"native"),e.join(s,"import")].filter(e=>i.existsSync(e)).forEach(t=>{n.push(t),n.push(e.join(t,"**/*"))}),n=n.map(e=>e.replace(/\\/g,"/")),await m(n,{force:!0})}}),N.task("save-settings",function(e){var t=P(oe,Y);i.outputFile(se.settings,t,e)}),N.task("save-configs",function(r){if(t.buildScriptsOnly)return r();for(var s=0;s<ne.length;s++){var n=ne[s],o=JSON.stringify(n.config,null,Y?4:0);i.outputFileSync(e.join(n.dest,"config.json"),o,"utf8")}r()}),N.task("compress-bundles",async function(){if(!t.buildScriptsOnly)for(let t=0;t<ne.length;++t){let r=ne[t];if("zip"!==r.compressionType)continue;let s=r.dest,n=[e.join(s,"native"),e.join(s,"import")].filter(e=>i.existsSync(e));n.length>0&&await S.compressDirs(n,s,e.join(s,"res.zip"),!1)}}),N.task("revision-configs",async function(){if(t.md5Cache){oe.bundleVers=Object.create(null);for(let t=0;t<ne.length;t++){let i=ne[t],r=o.sync(e.join(i.dest,"config.*"),{absolute:!0});0!==r.length&&(r=r[0],i.version=me(r,e.join(i.scriptDest,"index.js")),oe.bundleVers[i.name]=i.version)}}}),N.task("revision-other",async function(){if(!t.md5Cache)return;var i=["src/*.js","*"],r=ie,s=["index.html"];let n=[];te&&(s=s.concat(["main.js","cocos-project-template.json","project.json"]));var o=["settings.js","cocos2d-js-min.js","cocos2d-js.js","cocos2d-jsb.js","cocos2d-jsb-min.js"];let a=function(e){let t=I(e.actualPlatform,"md5"),i=null;t&&t.renameIgnore&&(i=t.renameIgnore(e),Array.isArray(i)||Editor.warn("renameIgnore must return an array"));return Array.isArray(i)?i:null}(t);a&&(s=s.concat(a));let l=function(e){let t=I(e.actualPlatform,"md5"),i=null;t&&t.searchIgnore&&(i=t.searchIgnore(e),Array.isArray(i)||Editor.warn("searchIgnore must return an array"));return Array.isArray(i)?i:null}(t);l&&(o=o.concat(l));let u=function(e){let t=I(e.actualPlatform,"md5"),i=null;t&&t.globalIgnore&&(i=t.globalIgnore(e),Array.isArray(i)||Editor.warn("renameIgnore must return an array"));return Array.isArray(i)?i:null}(t);u&&(n=n.concat(u)),"fb-instant-games"===t.platform&&(s=s.concat(["fbapp-config.json"])),Editor.isWin32&&(o=o.map(e=>e.replace(/\\/g,"/"))),await new Promise((t,a)=>{let l=N.src(i,{cwd:ie,base:r}).pipe(p.revision({debug:!0,hashLength:A,dontGlobal:n,dontRenameFile:s,dontSearchFile:o,annotator:function(e,t){return[{contents:e,path:t}]},replacer:function(t,i,r,s){".map"===e.extname(t.path)&&s.revPathOriginal+".map"!==t.path||(t.contents=t.contents.replace(i,"$1"+r+"$3$4"))}})).pipe(f()).pipe(N.dest(ie));l.on("end",t),l.on("error",e=>a(e))})}),N.task("before-change-files",function(e){let i=require(Editor.url("app://editor/share/build-utils"));Editor.Builder.doCustomProcess("before-change-files",i.getCommonOptions(t),ne,e)}),N.task("script-build-finished",function(e){let i=require(Editor.url("app://editor/share/build-utils"));Editor.Builder.doCustomProcess("script-build-finished",i.getCommonOptions(t),ne,e)}),N.task("copy-runtime-scripts",function(){var t=e.join(ie,"src");return N.src(e.join(se.tmplBase,"runtime/**/*.js")).pipe(N.dest(t))}),N.task("before-finish-build",async function(){await async function(e,t){return await W("beforeFinish",e,t)}(t,oe)}),N.task("encrypt-src-js",function(r){if(Y||!t.encryptJs)return r(),void 0;for(var s=e.join(ie,"src"),n=e.resolve(s,`../${se.backupDir}`),o=0,a=ne.length;o<a;o++){var l=ne[o];i.copySync(e.join(l.scriptDest,`index${t.md5Cache?"."+l.version:""}.js`),e.join(n,`${l.name}.index${t.md5Cache?"."+l.version:""}.js`))}i.copy(s,n,e=>{e&&Editor.warn("Failed to backup js files for debugging.",e),y.encryptJsFiles(t,[se.assets,se.remote],r)})}),N.task("build-jsb-adapter",function(){return Editor.require("app://editor/share/build-jsb-adapter").build({rootPath:Editor.url("packages://jsb-adapter"),dstPath:e.join(ie,"jsb-adapter"),excludedModules:t.excludedModules})}),N.task("build-common",N.series("query-bundles","compile","build-assets","build-configs","build-plugin-scripts","build-settings","compress-bundles")),N.task("finish-build",N.series("copy-build-template","before-change-files","revision-asset-jsList","compress-configs","save-configs","revision-configs","save-settings","revision-other")),N.task(x+"web-desktop",N.series("build-cocos2d",N.parallel("build-common","copy-webDebugger"),"build-web-desktop-template","finish-build")),N.task(x+"web-mobile",N.series("build-cocos2d",N.parallel("build-common","copy-webDebugger"),"build-web-mobile-template","finish-build")),N.task(x+"fb-instant-games",N.series("build-cocos2d",N.parallel("build-common","copy-webDebugger"),"build-fb-instant-games-template","finish-build")),N.task(x+"mini-game",N.series("build-cocos2d","build-common","script-build-finished","before-finish-build","finish-build")),N.task("copy-native-files",N.series("build-common","script-build-finished","copy-runtime-scripts","copy-main-js","before-finish-build","finish-build","encrypt-src-js")),N.task("build-cocos-native-project",function(e){y.build(t,e)}),N.task("build-native-project",N.series("build-cocos-native-project","build-cocos2d","build-jsb-adapter","copy-native-files")),N.task("copy-win32-dll",()=>{let t=["msvcp100.dll","msvcp110.dll","msvcp120.dll","msvcp120d.dll","msvcp140.dll","msvcp140d.dll","msvcr100.dll","msvcr110.dll","msvcr120.dll","msvcr120d.dll"],r=e.join(Editor.App.path,"cocos2d-x/simulator/win32"),s=e.join(ie,"frameworks/runtime-src/proj.win32","Debug.win32"),n=e.join(ie,"frameworks/runtime-src/proj.win32","Release.win32");return i.ensureDirSync(s),i.ensureDirSync(n),t=t.map(t=>e.join(r,t)),N.src(t,{allowEmpty:!0}).pipe(N.dest(s)).pipe(N.dest(n))}),N.task(x+"android",N.parallel("build-native-project")),N.task(x+"ios",N.parallel("build-native-project")),N.task(x+"win32",N.series("build-native-project","copy-win32-dll")),N.task(x+"mac",N.parallel("build-native-project")),N.task(x+"android-instant",N.parallel("build-native-project")),N.task(x+"runtime",N.series("build-cocos2d","copy-native-files")),Editor.Ipc.sendToMain("builder:state-changed","spawn-build-worker",0),h.normal("Start spawn build-worker");let ge,he=!1;function je(){F&&(F.nativeWin.off("close",F.onClose),F.nativeWin.webContents.off("crashed",F.onCaptureBuilderWorkerCrashed),F.nativeWin.webContents.off("did-finish-load",F.onDidFinishLoad),n.off("app:build-worker-log",F.onCaptureLog),n.off("app:build-project-abort",F.onCaptureBuilderWorkerError),F.window.close(),F=null,console.log("关闭 worker"))}F||((F=await function(e,t,i){return new Promise(r=>{Editor.App.spawnWorker(e,(e,t)=>{r({window:e,nativeWin:t})},t,i)})}("app://editor/page/build/build-worker",U,!0)).initBuildWorkerForAssets=!1,F.onCaptureBuilderWorkerError=function(e,t){he=!0,F&&!U&&je(),"string"==typeof t&&(t=t.replace(/^Error:\s*/,""),t=new Error(t)),ge&&ge(t)},F.onCaptureBuilderWorkerCrashed=function(e){F&&!U&&je(),ge&&ge("The build worker window crashed")},F.onDidFinishLoad=function(){F.initBuildWorkerForAssets=!1},F.onClose=function(){F&&(n.off("app:build-worker-log",F.onCaptureLog),n.off("app:build-project-abort",F.onCaptureBuilderWorkerError),F=null)},F.onCaptureLog=function(e,t){console.log(t)},F.nativeWin.on("close",F.onClose),F.nativeWin.webContents.on("crashed",F.onCaptureBuilderWorkerCrashed),F.nativeWin.webContents.on("did-finish-load",F.onDidFinishLoad),n.on("app:build-project-abort",F.onCaptureBuilderWorkerError),n.on("app:build-worker-log",F.onCaptureLog)),h.normal("Finish spawn build-worker");var ve=x+Z;if(ve in N._registry._tasks){let r=J((...e)=>{g&&g(...e)});var ye=[];let s=await async function(e){let t=await W("delPattern",e);return Array.isArray(t)?t:null}(t);if(s?ye=s:te?ye.push(se.assets+"/**/*",se.remote+"/**/*",se.src+"/**/*"):ye.push(e.join(ie,"**/*")),t.buildScriptsOnly){(Y?Editor.log:Editor.warn)(Editor.T("BUILDER.build_script_only_tips"));let r=o.sync([e.join(se.assets,"*"),e.join(se.remote,"*")],{absolute:!0});ye.push("!"+se.assets),ye.push("!"+se.remote),r.forEach(t=>{ye.push("!"+t),ye.push("!"+e.join(t,"config.*")),ye.push("!"+e.join(t,"import")),ye.push("!"+e.join(t,"import/**/*")),ye.push("!"+e.join(t,"native")),ye.push("!"+e.join(t,"native/**/*")),ye.push("!"+e.join(t,"*.zip"))}),ye.push("!"+se.subpackages),ye.push("!"+se.subpackages+"/**/*"),ye.push("!"+se.src),ye.push("!"+se.src+"/settings.js"),ye.push("!"+se.src+"/settings.*.js"),function(t){let r=e.join(t.dest,"src"),s=o.sync(r+"/settings.*",{absolute:!0});if(0===s.length)return;s=s[0];let n=e.extname(s);i.renameSync(s,e.join(r,`settings${n}`))}(t)}try{ye=ye.map(e=>e.replace(/\\/g,"/")),Editor.log("Delete "+ye),m.sync(ye,{force:!0}),N.once("error",function(e){r(function(e){return e.error?"boolean"==typeof e.error.showStack?e.error.toString():e.error.stack?e.error:new Error(String(e.error)):new Error(String(e.message))}(e))}),N.task(ve)(function(){te||Editor.Ipc.sendToMain("app:update-build-preview-path",ie),r(null,ne)})}catch(e){g&&g(e)}}else{var we=[];for(var Ee in N._registry._tasks)0===Ee.indexOf(x)&&we.push(Ee.substring(x.length));g(new Error(r("Not support %s platform, available platform currently: %s",Z,we)))}},exports.getTemplateFillPipe=$,exports.buildSettings=L,exports.buildConfig=R;